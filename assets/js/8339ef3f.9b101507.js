"use strict";(self.webpackChunkdebug_video=self.webpackChunkdebug_video||[]).push([[242],{3905:function(e,t,n){n.d(t,{Zo:function(){return m},kt:function(){return u}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},m=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,m=r(e,["components","mdxType","originalType","parentName"]),h=d(n),u=i,c=h["".concat(l,".").concat(u)]||h[u]||p[u]||o;return n?a.createElement(c,s(s({ref:t},m),{},{components:n})):a.createElement(c,s({ref:t},m))}));function u(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,s=new Array(o);s[0]=h;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:i,s[1]=r;for(var d=2;d<o;d++)s[d]=n[d];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},7324:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return r},contentTitle:function(){return l},metadata:function(){return d},toc:function(){return m},default:function(){return h}});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),s=["components"],r={},l="A short guide to streaming video",d={unversionedId:"short-guide-streaming-video",id:"short-guide-streaming-video",title:"A short guide to streaming video",description:"There are already many great resources describing how streaming video works:",source:"@site/docs/short-guide-streaming-video.md",sourceDirName:".",slug:"/short-guide-streaming-video",permalink:"/short-guide-streaming-video",tags:[],version:"current",frontMatter:{},sidebar:"sidebar",previous:{title:"How is this guide organized?",permalink:"/how-is-this-guide-organized"},next:{title:"Adressing new tickets",permalink:"/addressing-new-tickets"}},m=[{value:"Video Files",id:"video-files",children:[],level:2},{value:"Why use streaming video?",id:"why-use-streaming-video",children:[],level:2},{value:"How does streaming video work?",id:"how-does-streaming-video-work",children:[{value:"Cutting up a video file",id:"cutting-up-a-video-file",children:[],level:3},{value:"Requesting portions of the video",id:"requesting-portions-of-the-video",children:[],level:3},{value:"Live streams",id:"live-streams",children:[],level:3},{value:"Different renditions",id:"different-renditions",children:[],level:3},{value:"Mixing Content",id:"mixing-content",children:[],level:3}],level:2},{value:"Video Tag and Media Source Extensions",id:"video-tag-and-media-source-extensions",children:[],level:2},{value:"Container Formats",id:"container-formats",children:[{value:"MP4",id:"mp4",children:[],level:3},{value:"TS",id:"ts",children:[],level:3}],level:2}],p={toc:m};function h(e){var t=e.components,r=(0,i.Z)(e,s);return(0,o.kt)("wrapper",(0,a.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"a-short-guide-to-streaming-video"},"A short guide to streaming video"),(0,o.kt)("p",null,"There are already many great resources describing how streaming video works:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://howvideo.works/"},"HowVideo.works")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/leandromoreira/digital_video_introduction"},"Digital Video Introduction")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://awesome.video/"},"awesome.video"))),(0,o.kt)("p",null,"Because there are never enough, here's a quick introduction that should cover most topics needed to understand this guide."),(0,o.kt)("p",null,"Note that some of the topics are greatly simplified. For more technical discussions, please refer to some of the other excellent resources above."),(0,o.kt)("h2",{id:"video-files"},"Video Files"),(0,o.kt)("p",null,"A video file is a long stream of bits. There are two sections",(0,o.kt)("sup",{parentName:"p",id:"fnref-1"},(0,o.kt)("a",{parentName:"sup",href:"#fn-1",className:"footnote-ref"},"1")),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Metadata - bits that describe the file"),(0,o.kt)("li",{parentName:"ol"},"Video data - bits that are the actual content")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Image of video file metadata and video data",src:n(6472).Z})),(0,o.kt)("p",null,"When you open a video file on your computer, the video player parses the file to read the metadata and all of the video data."),(0,o.kt)("h2",{id:"why-use-streaming-video"},"Why use streaming video?"),(0,o.kt)("p",null,"To play a video file in a browser, you can use the ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video"},"HTML video element"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},'<video>\n  <source src="some-video.mp4" type="video/mp4">\n</video>\n')),(0,o.kt)("p",null,"The browser will download ",(0,o.kt)("inlineCode",{parentName:"p"},"some-video.mp4")," and play it."),(0,o.kt)("p",null,"This leads to a few problems:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Wasted bandwidth"))),(0,o.kt)("p",null,"Let's say a 1 minute MP4 file you have is over 100 MB. With an MP4 source in the ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," tag, the browser will try to download the entire video, whether you watch it all or not. If you pause the video, it will continue to buffer the entire MP4. This wastes bandwidth."),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"No support for live streams"))),(0,o.kt)("p",null,"With a single MP4 source, there's no good way of handling live streams. If you try to continually append to an MP4, the browser is going to try to download the entire live stream, from the beginning to the end. For 24/7 live streams, this means that users will most likely never reach the most live portion of the stream. And if the browser did manage to catch up, as soon as it reached the current end of the MP4 the browser would stop downloading content."),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"No support for different renditions"))),(0,o.kt)("p",null,"In the case of ",(0,o.kt)("inlineCode",{parentName:"p"},"some-video.mp4")," above, the content is 1080p. If a user is connected to 3G, they may not get to watch any of the video because the download is too slow. It would be better if they could download a 360p rendition instead."),(0,o.kt)("ol",{start:4},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"No support for mixing content from different videos"))),(0,o.kt)("p",null,"If a stream provider wants to insert an ad into the middle of the stream, there's no way to point to a different video in the middle of ",(0,o.kt)("inlineCode",{parentName:"p"},"some-video.mp4")," without encoding the ad into ",(0,o.kt)("inlineCode",{parentName:"p"},"some-video.mp4"),"."),(0,o.kt)("p",null,"Streaming video aims to solve these issues by providing ways to:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Cut a video file into smaller files."),(0,o.kt)("li",{parentName:"ol"},"Add new content for live streams."),(0,o.kt)("li",{parentName:"ol"},"Point to multiple renditions."),(0,o.kt)("li",{parentName:"ol"},"Mix content from different video files.")),(0,o.kt)("h2",{id:"how-does-streaming-video-work"},"How does streaming video work?"),(0,o.kt)("h3",{id:"cutting-up-a-video-file"},"Cutting up a video file"),(0,o.kt)("p",null,"Here's the image from earlier of ",(0,o.kt)("inlineCode",{parentName:"p"},"some-video.mp4"),":"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Image of video file metadata and video data",src:n(6472).Z})),(0,o.kt)("p",null,"The video file is divided into two sections: metadata and video data."),(0,o.kt)("p",null,"First, let's cut out the metadata."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Image of video file metadata cut from video data",src:n(6090).Z})),(0,o.kt)("p",null,"Next, let's cut the video data into smaller portions (each portion being a file)."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Image of segmented video file",src:n(2624).Z})),(0,o.kt)("p",null,"These portions are called segments, fragments, sections, or chunks. Different streaming protocols use different terms, but they're all essentially the same thing. For this guide we'll refer to them as segments."),(0,o.kt)("p",null,"The metadata segment is called an init (initialization) segment."),(0,o.kt)("p",null,"The data segments are called media segments, and are often referred to simply as segments."),(0,o.kt)("p",null,"Say each segment represents 10 seconds of video data. Now, if a user seeks to 30 seconds in the video, the first 3 segments can be skipped, and less bandwidth is used."),(0,o.kt)("h3",{id:"requesting-portions-of-the-video"},"Requesting portions of the video"),(0,o.kt)("p",null,"But how does the HTML ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," tag know about multiple segments and what portions of content they represent?"),(0,o.kt)("p",null,"Here's where streaming media protocols come in. The two most popular are HLS and DASH."),(0,o.kt)("p",null,"HLS starts with a .m3u8 file that has a series of lines, some with special tags. The specification is relatively small and easy to read. It can be found at ",(0,o.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/draft-pantos-hls-rfc8216bis-10"},"https://datatracker.ietf.org/doc/html/draft-pantos-hls-rfc8216bis-10")," "),(0,o.kt)("p",null,"DASH starts with a .mpd file that is in XML format. The specification is large and can be found at ",(0,o.kt)("a",{parentName:"p",href:"https://standards.iso.org/ittf/PubliclyAvailableStandards/index.html"},"https://standards.iso.org/ittf/PubliclyAvailableStandards/index.html")," (look for ISO/IEC 23009-1:2019 -  Information technology \u2014 Dynamic adaptive streaming over HTTP (DASH) \u2014 Part 1: Media presentation description and segment formats)."),(0,o.kt)("p",null,"Whether using HLS or DASH, those files, the .m3u8 and .mpd files, are called manifests."),(0,o.kt)("p",null,"Because HLS manifests are often easier to read, let's put the cut up video from before into an HLS Media Playlist called ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:3\n#EXT-X-MAP:URI="init-segment.mp4"\n#EXTINF:10\nsegment0.mp4\n#EXTINF:10\nsegment1.mp4\n#EXTINF:10\nsegment2.mp4\n#EXTINF:10\nsegment3.mp4\n#EXTINF:10\nsegment4.mp4\n#EXTINF:10\nsegment5.mp4\n#EXT-X-ENDLIST\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"EXT-X-MAP")," tag points to the init segment (containing the metadata for the video) and then each of the video data segments follow, with their duration preceding their URLs."),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Init Segments")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},'Note that you will not always see init segments. If they\'re not included, it means that segments are "self initializing," meaning they have the metadata included in the segment.'))),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8")," provides an easy way for a player to see how a video file is broken into segments. Now, instead of a player having to request an entire video file to play content starting from 30 seconds, it can skip over ",(0,o.kt)("inlineCode",{parentName:"p"},"segment0.mp4"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"segment1.mp4"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"segment2.mp4")," and start downloading from ",(0,o.kt)("inlineCode",{parentName:"p"},"segment3.mp4"),"."),(0,o.kt)("p",null,"For browser that suport HLS (.m3u8 files) and DASH (.mpd files) natively, you can drop them into a ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," tag and everything should work:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'<video>\n  <source src="media-1080.m3u8" type="application/x-mpegURL">\n</video>\n')),(0,o.kt)("p",null,"By using a media playlist, we've (largely) solved the ",(0,o.kt)("strong",{parentName:"p"},"wasted bandwidth")," problem."),(0,o.kt)("h3",{id:"live-streams"},"Live streams"),(0,o.kt)("p",null,"But what about live streams? Well, the ",(0,o.kt)("inlineCode",{parentName:"p"},"#EXT-X-ENDLIST")," tag at the end of ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8")," marks the stream as VOD (video on demand, meaning the entire video is known at start and has a fixed duration). If you remove the ",(0,o.kt)("inlineCode",{parentName:"p"},"#EXT-X-ENDLIST")," tag from ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8")," then the stream becomes live. This means that the player will periodically re-request ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8")," from the server (in the case of ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8"),", about every 10 seconds), and check for new segments."),(0,o.kt)("p",null,"So if a user starts playing the stream and it shows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:3\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-DISCONTINUITY-SEQUENCE:0\n#EXT-X-MAP:URI="init-segment.mp4"\n#EXTINF:10\nsegment0.mp4\n#EXTINF:10\nsegment1.mp4\n#EXTINF:10\nsegment2.mp4\n#EXTINF:10\nsegment3.mp4\n#EXTINF:10\nsegment4.mp4\n#EXTINF:10\nsegment5.mp4\n')),(0,o.kt)("p",null,"This is the same ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8")," with the ",(0,o.kt)("inlineCode",{parentName:"p"},"EXT-X-ENDLIST")," tag removed. "),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Note on Media Sequence and Discontinuity Sequence")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"You may have noticed that two extra tags were added:"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre"},"#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-DISCONTINUITY-SEQUENCE:0\n")),(0,o.kt)("p",{parentName:"div"},"These will be discussed ",(0,o.kt)("a",{parentName:"p",href:"manifest-issues#alternate-renditions-with-synchronization-issues"},"later in this guide"),", but in short, these two numbers help maintain sync between different renditions and manifest refreshes."))),(0,o.kt)("p",null,"Ten seconds later, the player requests ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8")," and it shows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:3\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-DISCONTINUITY-SEQUENCE:0\n#EXT-X-MAP:URI="init-segment.mp4"\n#EXTINF:10\nsegment0.mp4\n#EXTINF:10\nsegment1.mp4\n#EXTINF:10\nsegment2.mp4\n#EXTINF:10\nsegment3.mp4\n#EXTINF:10\nsegment4.mp4\n#EXTINF:10\nsegment5.mp4\n#EXTINF:10\nsegment6.mp4\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"segment6.mp4")," was added and represents 10 seconds of new content. That's it. Live streams are supported."),(0,o.kt)("h3",{id:"different-renditions"},"Different renditions"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8")," provides a way for us to save bandwidth by seeking in a video without downloading the entire stream. It also allows us to add content to make a live stream. But it's still only one rendition, 1080p. "),(0,o.kt)("p",null,"If a user is watching a video on their phone, walks out of the house, lost WIFI, and is now on 3G, we still want playback to continue. If 3G can't support a 1080p rendition then the player should switch to a 360p rendition without any playback interruption."),(0,o.kt)("p",null,"We need a 360p video file split into segments, and a ",(0,o.kt)("inlineCode",{parentName:"p"},"media-360.m3u8")," manifest:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:3\n#EXT-X-MAP:URI="init-segment.mp4"\n#EXTINF:10\nsegment0.mp4\n#EXTINF:10\nsegment1.mp4\n#EXTINF:10\nsegment2.mp4\n#EXTINF:10\nsegment3.mp4\n#EXTINF:10\nsegment4.mp4\n#EXTINF:10\nsegment5.mp4\n#EXT-X-ENDLIST\n')),(0,o.kt)("p",null,"Note that the manifest looks exactly the same as ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8"),", the key is it exists at a different URL. If ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8")," exists at ",(0,o.kt)("a",{parentName:"p",href:"http://example.com/media-1080.m3u8"},"http://example.com/media-1080.m3u8"),", then ",(0,o.kt)("inlineCode",{parentName:"p"},"media-360.m3u8")," may exist at ",(0,o.kt)("a",{parentName:"p",href:"http://example.com/media-360.m3u8"},"http://example.com/media-360.m3u8"),". But how does the ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," tag know about this other rendition?"),(0,o.kt)("p",null,'DASH uses one manifest for a stream, and will list all renditions in a single .mpd file. HLS uses one manifest to list renditions, and different manifests for each rendition. In the HLS spec the manifest which lists other manifests is referred to as a "multivariant playlist," where variant is another term for rendition. In the community you may often hear the term "main manifest" to mean a multivariant playlist. The rendition manifests are referred to in the spec as "media playlists." This sounds complicated, but let\'s write a multivariant playlist and put it on our server as ',(0,o.kt)("a",{parentName:"p",href:"http://example.com/multivariant.m3u8"},"http://example.com/multivariant.m3u8"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"#EXTM3U\n#EXT-X-STREAM-INF:BANDWIDTH=1280000\nhttp://example.com/media-360.m3u8\n#EXT-X-STREAM-INF:BANDWIDTH=2560000,AVERAGE-BANDWIDTH=2000000\nhttp://example.com/media-1080.m3u8\n")),(0,o.kt)("p",null,"Now, when setting up the ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," tag, instead of pointing to ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8"),", point to ",(0,o.kt)("inlineCode",{parentName:"p"},"multivariant.m3u8"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'<video>\n  <source src="http://example.com/multivariant.m3u8" type="application/x-mpegURL">\n</video>\n')),(0,o.kt)("p",null,"Now, if the player sees changes in the user's bandwidth, it can switch between ",(0,o.kt)("inlineCode",{parentName:"p"},"media-360")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"media-1080.m3u8"),"."),(0,o.kt)("p",null,"With multiple renditions supported, the only thing left is to handle mixing content from different videos."),(0,o.kt)("h3",{id:"mixing-content"},"Mixing Content"),(0,o.kt)("p",null,"Let's say you're running a 24/7 live stream, and every 30 seconds you want to run the same 10 second ad. To do this, you need to somehow insert that ad into the media playlst. But you have a problem. Video files have timestamps, so, looking at our sample live stream from above:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:3\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-DISCONTINUITY-SEQUENCE:0\n#EXT-X-MAP:URI="init-segment.mp4"\n#EXTINF:10\nsegment0.mp4\n#EXTINF:10\nsegment1.mp4\n#EXTINF:10\nsegment2.mp4\n#EXTINF:10\nsegment3.mp4\n#EXTINF:10\nsegment4.mp4\n#EXTINF:10\nsegment5.mp4\n')),(0,o.kt)("p",null,"We know that segment0.mp4 runs from times 0 seconds to 10 seconds, and segment1.mp4 runs from times 10 seconds to 20 seconds, and so on. Not only is it written in the manifest as such, but the media files themselves (segment0.mp4 and segment1.mp4) have times embedded into them. If you insert ",(0,o.kt)("inlineCode",{parentName:"p"},"ad-segment0.ts")," after ",(0,o.kt)("inlineCode",{parentName:"p"},"segment2.ts")," expecting it to play from time 30 seconds to 40 seconds in the stream, you'll end up with a problem:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:3\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-DISCONTINUITY-SEQUENCE:0\n#EXT-X-MAP:URI="init-segment.mp4"\n#EXTINF:10\nsegment0.mp4\n#EXTINF:10\nsegment1.mp4\n#EXTINF:10\nsegment2.mp4\n#EXTINF:10\nad-segment0.mp4\n#EXTINF:10\nsegment3.mp4\n#EXTINF:10\nsegment4.mp4\n#EXTINF:10\nsegment5.mp4\n')),(0,o.kt)("p",null,"The problem is that ",(0,o.kt)("inlineCode",{parentName:"p"},"ad-segment0.mp4"),"'s media times will report 0 seconds to 10 seconds, the same as ",(0,o.kt)("inlineCode",{parentName:"p"},"segment0.mp4"),", so the ad segment will overwrite ",(0,o.kt)("inlineCode",{parentName:"p"},"segment0.ts"),"'s content in the buffer, and won't play at the time expected."),(0,o.kt)("p",null,'Streaming media provides a way for us to insert content from different sources, with different timing, into the same stream. In HLS it\'s called a "discontinuity" (since the content is discontinuous). In DASH you\'ll see the same feature as different "Periods."'),(0,o.kt)("p",null,"What these discontinuities do is tell the player that the content is from a different source, and the times in the segments should be adjusted. To insert ",(0,o.kt)("inlineCode",{parentName:"p"},"ad-segment0.mp4")," into the stream in a way that will position the ad starting at time 30 seconds, the manifest should be modified to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#EXTM3U\n#EXT-X-TARGETDURATION:10\n#EXT-X-VERSION:3\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-DISCONTINUITY-SEQUENCE:0\n#EXT-X-MAP:URI="init-segment.mp4"\n#EXTINF:10\nsegment0.mp4\n#EXTINF:10\nsegment1.mp4\n#EXTINF:10\nsegment2.mp4\n#EXT-X-DISCONTINUITY\n#EXT-X-MAP:URI="ad-init-segment.mp4"\n#EXTINF:10\nad-segment0.mp4\n#EXT-X-DISCONTINUITY\n#EXT-X-MAP:URI="init-segment.mp4"\n#EXTINF:10\nsegment3.mp4\n#EXTINF:10\nsegment4.mp4\n#EXTINF:10\nsegment5.mp4\n')),(0,o.kt)("p",null,"When the player reaches an ",(0,o.kt)("inlineCode",{parentName:"p"},"EXT-X-DISCONTINUITY"),' tag, it knows to adjust the times of the following segments so that the content follows what came before in the manifest. This timestamp adjustment is called a "timestamp offset." In this case, ad-segment0.mp4, which has a media start time of 0 seconds, will be adjusted by 30 seconds, so all timestamps in the segment will have 30 seconds added to them.'),(0,o.kt)("p",null,"Note also that different content will generally have different metadata, so ",(0,o.kt)("inlineCode",{parentName:"p"},"EXT-X-MAP")," tags for the init segments are required before discontinuous content."),(0,o.kt)("h2",{id:"video-tag-and-media-source-extensions"},"Video Tag and Media Source Extensions"),(0,o.kt)("p",null,"For the examples above, we've put HLS sources directly into ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," tags, e.g.:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'<video>\n  <source src="http://example.com/multivariant.m3u8" type="application/x-mpegURL">\n</video>\n')),(0,o.kt)("p",null,"Some browsers support this (e.g., Safari natively supports HLS). But what if the browser doesn't support that type (in this case HLS)?"),(0,o.kt)("p",null,"Here's where MSE (",(0,o.kt)("a",{parentName:"p",href:"https://www.w3.org/TR/media-source/"},"Media Source Extensions"),") becomes a great tool. MSE provides a way for developers to append segments of video to a ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," tag instead of providing a ",(0,o.kt)("inlineCode",{parentName:"p"},"<source>")," directly."),(0,o.kt)("p",null,"Browser-based video players generally use the MSE APIs to handle source types that the browser doesn't natively support. For instance, since Chrome doesn't natively support HLS, the following are a few players you can use to support playback of HLS in Chrome:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/videojs/video.js"},"Video.js")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/video-dev/hls.js"},"hls.js")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/google/shaka-player"},"Shaka Player"))),(0,o.kt)("p",null,"To use MSE, the player will create one ",(0,o.kt)("a",{parentName:"p",href:"https://www.w3.org/TR/media-source/#mediasource"},"MediaSource object"),", which you can read as a source of media data, and use that as the source of the ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," element:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const mediaSource = new MediaSource();\n// videoElement is the <video> tag object\nconst videoElement.src = URL.createObjectURL(mediaSource);\n")),(0,o.kt)("p",null,"Once the mediaSource object is ready, ",(0,o.kt)("a",{parentName:"p",href:"https://www.w3.org/TR/media-source/#sourcebuffer"},"SourceBuffer objects")," can be added:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const audioBuffer = mediaSource.addSourceBuffer('audio/mp4; codecs=\"mp4a.40.2\"');\nconst videoBuffer = mediaSource.addSourceBuffer('video/mp4; codecs=\"avc1.4d400d\"');\n")),(0,o.kt)("p",null,"Now that audio and video buffers have been created, MP4 segments can be appended to them:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// Here segmentData is an ArrayBuffer of an MP4 segment, say segment0.mp4 from the examples\nvideoBuffer.appendBuffer(segmentData).\n")),(0,o.kt)("p",null,"The APIs are a bit more involved, but those are the basics. Once an append of ",(0,o.kt)("inlineCode",{parentName:"p"},"segment0.mp4")," completes, the ",(0,o.kt)("inlineCode",{parentName:"p"},"<video>")," element will have 10 seconds of buffered content (from 0 seconds to 10 seconds)."),(0,o.kt)("p",null,"Note that different browsers support different MIME types. If the browser doesn't support the MIME type when creating the buffer, a ",(0,o.kt)("a",{parentName:"p",href:"https://webidl.spec.whatwg.org/#notsupportederror"},"NotSupportedError")," will be thrown."),(0,o.kt)("p",null,"Note also that different container formats are supported by different browsers."),(0,o.kt)("h2",{id:"container-formats"},"Container Formats"),(0,o.kt)("p",null,"For the guide thus far, we've been using MP4 files. But there are also other file types. The most common you will see in streaming media are MP4 and TS."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Container_format_(computing)"},"Container formats")," provide a way of wrapping media data with metadata into a single file. In the examples above, we split a video file into metadata and video data. But what if there's also audio data? And what if there are captions too? Container formats provide well defined ways of combining different streams together, and describing them (via metadata), to make the files easy for players (and us) to read and understand."),(0,o.kt)("p",null,"For more detailed discussions of container formats, please see some of the links to at the top of this page, but for a very quick introduction to the primary ones, MP4 and TS, here's a very high level overview of what they are."),(0,o.kt)("h3",{id:"mp4"},"MP4"),(0,o.kt)("p",null,"MP4 files are very easy to read. They're composed of a sequential list of boxes (which used to be called atoms). Each box has 3 sections: 4 bytes describing the length of the box (in bytes), 4 bytes describing the type of box, then the box contents. For browser-based media streaming, you can refer to the ",(0,o.kt)("a",{parentName:"p",href:"https://www.w3.org/TR/mse-byte-stream-format-isobmff/"},"ISO BMFF MSE bytestream format specification")," for a listing of the boxes that MSE expects, and the ISO BMFF specification (ISO/IEC 14996-12), for the box definitions."),(0,o.kt)("p",null,"If you run ",(0,o.kt)("a",{parentName:"p",href:"segment-issues#xxd"},"xxd")," or ",(0,o.kt)("a",{parentName:"p",href:"segment-issues#xxd"},"mp4dump")," on an MP4 segment, you can see the boxes listed."),(0,o.kt)("h3",{id:"ts"},"TS"),(0,o.kt)("p",null,'TS files are a sequential series of 188 byte "sections," where each section starts with a "sync byte" (ASCII character \'G\') followed by metadata information and the media data. The bitstream specification for a packet can be found at the ',(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/MPEG_transport_stream#Packet"},"wiki article"),"."),(0,o.kt)("p",null,"If you run ",(0,o.kt)("a",{parentName:"p",href:"segment-issues#xxd"},"xxd")," on a TS segment, you can see the sync bytes representing the packets (every 188 bytes)."),(0,o.kt)("div",{className:"footnotes"},(0,o.kt)("hr",{parentName:"div"}),(0,o.kt)("ol",{parentName:"div"},(0,o.kt)("li",{parentName:"ol",id:"fn-1"},"Note that metadata may also be found in more places than just the beginning of the video file. To keep things simple, we'll only discuss metadata at the beginning.",(0,o.kt)("a",{parentName:"li",href:"#fnref-1",className:"footnote-backref"},"\u21a9")))))}h.isMDXComponent=!0},6090:function(e,t){t.Z="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8c3R5bGU+CiAgICB0ZXh0IHsKICAgICAgZm9udDogYm9sZCAxMnB4IHNhbnMtc2VyaWY7CiAgICB9CiAgPC9zdHlsZT4KCiAgPHJlY3QgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9ImJsdWUiIC8+CiAgPHRleHQgeD0iMjAiIHk9IjUwIiBmaWxsPSJ3aGl0ZSI+TWV0YWRhdGE8L3RleHQ+CgogIDxyZWN0IHg9IjEyMCIgeT0iMCIgd2lkdGg9IjYwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InJlZCIgLz4KICA8dGV4dCB4PSIzMDAiIHk9IjUwIiBmaWxsPSJ3aGl0ZSI+VmlkZW8gRGF0YTwvdGV4dD4KPC9zdmc+Cg=="},2624:function(e,t){t.Z="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODQwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8c3R5bGU+CiAgICB0ZXh0IHsKICAgICAgZm9udDogYm9sZCAxMXB4IHNhbnMtc2VyaWY7CiAgICB9CiAgPC9zdHlsZT4KCiAgPHJlY3QgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9ImJsdWUiIC8+CiAgPHRleHQgeD0iMjAiIHk9IjUwIiBmaWxsPSJ3aGl0ZSI+TWV0YWRhdGE8L3RleHQ+CiAgPHRleHQgeD0iNSIgeT0iNzAiIGZpbGw9IndoaXRlIj5pbml0LXNlZ21lbnQubXA0PC90ZXh0PgoKICA8cmVjdCB4PSIxMjAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSJyZWQiIC8+CiAgPHRleHQgeD0iMTMwIiB5PSI1MCIgZmlsbD0id2hpdGUiPnNlZ21lbnQwLm1wNDwvdGV4dD4KCiAgPHJlY3QgeD0iMjQwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0icmVkIiAvPgogIDx0ZXh0IHg9IjI1MCIgeT0iNTAiIGZpbGw9IndoaXRlIj5zZWdtZW50MS5tcDQ8L3RleHQ+CgogIDxyZWN0IHg9IjM2MCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InJlZCIgLz4KICA8dGV4dCB4PSIzNzAiIHk9IjUwIiBmaWxsPSJ3aGl0ZSI+c2VnbWVudDIubXA0PC90ZXh0PgoKICA8cmVjdCB4PSI0ODAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSJyZWQiIC8+CiAgPHRleHQgeD0iNDkwIiB5PSI1MCIgZmlsbD0id2hpdGUiPnNlZ21lbnQzLm1wNDwvdGV4dD4KCiAgPHJlY3QgeD0iNjAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0icmVkIiAvPgogIDx0ZXh0IHg9IjYxMCIgeT0iNTAiIGZpbGw9IndoaXRlIj5zZWdtZW50NC5tcDQ8L3RleHQ+CgogIDxyZWN0IHg9IjcyMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InJlZCIgLz4KICA8dGV4dCB4PSI3MzAiIHk9IjUwIiBmaWxsPSJ3aGl0ZSI+c2VnbWVudDUubXA0PC90ZXh0Pgo8L3N2Zz4K"},6472:function(e,t){t.Z="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8c3R5bGU+CiAgICB0ZXh0IHsKICAgICAgZm9udDogYm9sZCAxMnB4IHNhbnMtc2VyaWY7CiAgICB9CiAgPC9zdHlsZT4KCiAgPHRleHQgeT0iMjUiIHg9IjMwMCI+VmlkZW8gRmlsZTwvdGV4dD4KICA8cGF0aCBkPSJNMSw0MCBMMSwzNSBMNjk5LDM1IEw2OTksNDAiIHN0cm9rZT0iYmxhY2siIGZpbGw9InRyYW5zcGFyZW50IiAvPgoKICA8cmVjdCB5PSI1MCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9ImJsdWUiIC8+CiAgPHRleHQgeD0iMjAiIHk9IjEwMCIgZmlsbD0id2hpdGUiPk1ldGFkYXRhPC90ZXh0PgoKICA8cmVjdCB4PSIxMDAiIHk9IjUwIiB3aWR0aD0iNjAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0icmVkIiAvPgogIDx0ZXh0IHg9IjMwMCIgeT0iMTAwIiBmaWxsPSJ3aGl0ZSI+VmlkZW8gRGF0YTwvdGV4dD4KPC9zdmc+Cg=="}}]);